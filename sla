#importando bibliotecas
import tkinter as tk
from tkinter import ttk, filedialog, messagebox, font
import pandas as pd
import os
import sys

class ConciliaFacil:
    def __init__(self, root):
        self.root = root
        self.root.title("Concilia Fácil - Suporta Qualquer Formato")
        self.root.geometry("600x350")
        self.root.configure(bg="#f0f0f0")

        # Configurar fonte grande
        self.fonte_grande = font.Font(size=12)

        # Verificar dependências
        self.verificar_dependencias()

        # Variáveis
        self.arquivo1 = ""
        self.arquivo2 = ""
        self.df1 = None
        self.df2 = None

        # Criar interface
        self.criar_interface()

    def verificar_dependencias(self):
        try:
            import pandas
            import openpyxl
        except ImportError as e:
            messagebox.showerror(
                "Erro de Dependência",
                f"Faltam bibliotecas necessárias. Instale-as com:\n\n"
                f"pip install pandas openpyxl\n\n"
                f"Erro: {str(e)}"
            )
            sys.exit(1)

    def criar_interface(self):
        # Título
        titulo = ttk.Label(
            self.root,
            text=" Concilia Fácil",
            font=("Arial", 16, "bold"),
            background="#f0f0f0"
        )
        titulo.pack(pady=20)

        # Passo 1: Carregar Planilha 1
        frame_passo1 = ttk.Frame(self.root)
        frame_passo1.pack(pady=10)
        ttk.Label(frame_passo1, text="1. Clique para escolher a PRIMEIRA planilha:", font=self.fonte_grande).pack(side="left")
        self.btn_plan1 = ttk.Button(frame_passo1, text="Abrir Planilha 1", command=lambda: self.carregar_arquivo(1))
        self.btn_plan1.pack(side="left", padx=10)

        # Passo 2: Carregar Planilha 2
        frame_passo2 = ttk.Frame(self.root)
        frame_passo2.pack(pady=10)
        ttk.Label(frame_passo2, text="2. Clique para escolher a SEGUNDA planilha:", font=self.fonte_grande).pack(side="left")
        self.btn_plan2 = ttk.Button(frame_passo2, text="Abrir Planilha 2", command=lambda: self.carregar_arquivo(2))
        self.btn_plan2.pack(side="left", padx=10)

        # Passo 3: Botão Mágico
        btn_conciliar = ttk.Button(
            self.root,
            text=" CLIQUE AQUI PARA CONCILIAR ",
            command=self.conciliar,
            style="Big.TButton"
        )
        btn_conciliar.pack(pady=30)
        self.root.style = ttk.Style()
        self.root.style.configure("Big.TButton", font=("Arial", 14, "bold"), foreground="blue")

        # Status
        self.status = ttk.Label(self.root, text="", background="#f0f0f0")
        self.status.pack()

    def carregar_arquivo(self, num):
        arquivo = filedialog.askopenfilename(
            title=f"Selecione a Planilha {num}",
            filetypes=[("Excel", "*.xlsx *.xls"), ("CSV", "*.csv"), ("Texto", "*.txt"), ("Todos os arquivos", "*.*")]
        )
        if arquivo:
            nome_arquivo = os.path.basename(arquivo)
            if num == 1:
                self.arquivo1 = arquivo
                self.df1 = self.ler_arquivo(arquivo)
                self.btn_plan1.config(text=f"Planilha 1: {nome_arquivo}")
            else:
                self.arquivo2 = arquivo
                self.df2 = self.ler_arquivo(arquivo)
                self.btn_plan2.config(text=f"Planilha 2: {nome_arquivo}")
            self.status.config(text=f" Planilha {num} carregada!")

    def ler_arquivo(self, caminho):
        # Verifica a extensão do arquivo
        extensao = os.path.splitext(caminho)[1].lower()

        try:
            if extensao in [".xlsx", ".xls"]:
                return pd.read_excel(caminho, engine='openpyxl')
            elif extensao == ".csv":
                return pd.read_csv(caminho, delimiter=';')  # Delimitador padrão: ponto e vírgula
            elif extensao == ".txt":
                return pd.read_csv(caminho, delimiter='\t')  # Delimitador padrão: tabulação
            elif extensao == ".ods":
                return pd.read_excel(caminho, engine="odf")
            elif extensao == ".json":
                return pd.read_json(caminho)
            else:
                messagebox.showerror(
                    "Formato não suportado",
                    f"O formato '{extensao}' não é suportado. Use .xlsx, .xls, .csv, .txt, .ods ou .json."
                )
                return None
        except Exception as e:
            messagebox.showerror(
                "Erro ao ler o arquivo",
                f"Não foi possível ler o arquivo. Verifique o formato e o conteúdo.\nErro: {str(e)}"
            )
            return None

    def conciliar(self):
        if not self.arquivo1 or not self.arquivo2:
            messagebox.showerror("Ops!", "Carregue as duas planilhas primeiro!")
            return

        if self.df1 is None or self.df2 is None:
            messagebox.showerror("Erro", "Erro ao carregar as planilhas. Verifique os arquivos e tente novamente.")
            return

        try:
            # Encontrar colunas comuns
            colunas_comuns = list(set(self.df1.columns) & set(self.df2.columns))
            if not colunas_comuns:
                messagebox.showerror("Erro", "Não há colunas comuns nas planilhas!")
                return

            # Merge das planilhas
            merged = pd.merge(self.df1, self.df2, on=colunas_comuns, how="outer", suffixes=("_Plan1", "_Plan2"), indicator=True)

            # Identificar divergências
            divergencias = merged[merged["_merge"] != "both"]

            # Comparar valores nas colunas comuns
            iguais = pd.DataFrame()
            diferentes = pd.DataFrame()
            for coluna in colunas_comuns:
                iguais_coluna = merged[merged.apply(lambda row: row[f"{coluna}_Plan1"] == row[f"{coluna}_Plan2"], axis=1)]
                diferentes_coluna = merged[~merged.apply(lambda row: row[f"{coluna}_Plan1"] == row[f"{coluna}_Plan2"], axis=1)]
                iguais = pd.concat([iguais, iguais_coluna])
                diferentes = pd.concat([diferentes, diferentes_coluna])

            # Criar relatório
            relatorio_path = os.path.join(os.path.expanduser("~"), "Desktop", "RelatorioConciliação.xlsx")
            with pd.ExcelWriter(relatorio_path) as writer:
                if not divergencias.empty:
                    divergencias.to_excel(writer, sheet_name="Divergências", index=False)
                if not iguais.empty:
                    iguais.to_excel(writer, sheet_name="Valores Iguais", index=False)
                if not diferentes.empty:
                    diferentes.to_excel(writer, sheet_name="Valores Diferentes", index=False)

            # Abrir relatório automaticamente
            os.startfile(relatorio_path)
            self.status.config(text=" Pronto! O relatório foi salvo na ÁREA DE TRABALHO!")

        except Exception as e:
            messagebox.showerror("Erro", f"Algo deu errado. Verifique o formato do arquivo!\nErro: {str(e)}")

if __name__ == "__main__":
    root = tk.Tk()
    app = ConciliaFacil(root)
    root.mainloop()